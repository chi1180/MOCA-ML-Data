# オンデマンドバス 需要数予測用ダミーデータ生成スクリプト

## 概要

過疎地域のオンデマンドバス需要数を予測するための機械学習モデル開発において、実データを補完・拡張するためのダミーデータを生成するスクリプトです。

実運行データ（2023〜2025年度）のEDA結果を反映し、統計的に現実に即したダミーデータを生成します。

---

## 出力仕様

| 項目               | 内容                                                |
| ------------------ | --------------------------------------------------- |
| 形式               | CSV（1行 = 1日 × 1時間帯）                          |
| 時間帯             | morning / daytime / evening の3区分                 |
| 目的変数           | `demand_count`：その日・時間帯の予約件数（0を含む） |
| 列数               | 25列                                                |
| 期間（デフォルト） | 2020-04-01 〜 2025-03-31（約5,400レコード）         |

---

## 特徴量一覧

### カレンダー系

| 列名                        | 型  | 説明                                          |
| --------------------------- | --- | --------------------------------------------- |
| `date`                      | str | 日付（YYYY-MM-DD）                            |
| `time_slot`                 | str | 時間帯（morning / daytime / evening）         |
| `day_of_week`               | int | 曜日（0=月曜〜6=日曜）                        |
| `month`                     | int | 月                                            |
| `is_weekend`                | int | 週末フラグ（0/1）                             |
| `is_holiday`                | int | 祝日フラグ（0/1）                             |
| `is_school_term`            | int | 学期中フラグ（広島県カレンダー準拠）          |
| `is_farming_season`         | int | 農繁期フラグ（5・6・9・10月）                 |
| `is_month_boundary`         | int | 月初月末フラグ（1〜5日 または 25日〜）        |
| `season`                    | str | 季節（spring / summer / autumn / winter）     |
| `consecutive_holiday_count` | int | **【新規】** 連休の通算日数（GW・年末年始等） |

### 気象系

| 列名                 | 型    | 説明                                                                     |
| -------------------- | ----- | ------------------------------------------------------------------------ |
| `temperature`        | float | 気温（℃）。東広島市付近の月別実測値を参考                                |
| `feels_like_temp`    | float | **【新規】** 体感温度（℃）。気温と風速から算出                           |
| `precipitation_mm`   | float | 降水量（mm）                                                             |
| `snowfall_cm`        | float | 積雪量（cm）。1〜2月・気温0℃以下の場合に発生                             |
| `wind_speed`         | float | 風速（m/s）                                                              |
| `weather_label`      | str   | 天候ラベル（sunny / cloudy / rainy / snowy）                             |
| `is_extreme_weather` | int   | **【新規】** 悪天候フラグ（大雨≥20mm または 積雪≥5cm または 強風≥10m/s） |

### ラグ系

| 列名                | 型    | 説明                           |
| ------------------- | ----- | ------------------------------ |
| `lag_1_demand`      | float | 前日同時間帯の需要数           |
| `lag_7_demand`      | float | 1週前同時間帯の需要数          |
| `lag_14_demand`     | float | 2週前同時間帯の需要数          |
| `rolling_7day_avg`  | float | 直近7日間の同時間帯平均需要数  |
| `rolling_14day_avg` | float | 直近14日間の同時間帯平均需要数 |

### 運行履歴系

| 列名                        | 型    | 説明                                  |
| --------------------------- | ----- | ------------------------------------- |
| `days_since_last_operation` | float | **【新規】** 前回運行日からの経過日数 |

---

## EDAに基づく改良点

### 使用した実データ

- 対象：東広島市豊栄地区オンデマンドバス運行記録
- 期間：2023年度〜2025年度（3ヶ年）
- 路線：吉原線・能良線・乃美陰地線・安宿線・清武西線

### 主な発見と反映内容

#### 1. ゼロ需要率の較正

実データでは便単位のゼロ需要率が **78.4%** であることが判明。旧スクリプトの56%から大幅に乖離していたため、基礎λ（ポアソン分布の期待値）を全体的に引き下げて修正。

```
旧スクリプト: ゼロ需要率 約56%
改良版      : ゼロ需要率 約77%（実データ78.4%に近似）
```

#### 2. 月別係数の較正（最重要）

実データを月別に集計したところ、**4月の需要が他月の約3倍**という明確なパターンが存在。新年度の通院・通学需要の集中が原因と考えられる。旧スクリプトにはこのパターンが存在しなかった。

| 月     | 実データ係数 | 旧スクリプト      |
| ------ | ------------ | ----------------- |
| 4月    | **3.12**     | ≒ 1.0（考慮なし） |
| 8月    | 0.70         | ≒ 1.0（考慮なし） |
| 1〜3月 | 0.56〜0.66   | ≒ 1.0（考慮なし） |

#### 3. 週末需要の較正

実データで週末の需要は平日の **約0.49倍**。旧スクリプトの0.55倍から修正。

#### 4. 月初月末（通院需要）の較正

実データで月初月末（1〜5日・25〜31日）の需要は中旬の **約1.82倍**。旧スクリプトの1.35倍から修正。

#### 5. 新規特徴量の追加

**`consecutive_holiday_count`（連休通算日数）**
- GW・年末年始・シルバーウィーク等の長期連休を自然に捉えるため追加
- 連休が長いほど需要が抑制されるパターンをモデル化

**`feels_like_temp`（体感温度）**
- 気温単体より外出意欲との相関が高いと判断
- `temperature - 0.4 × max(wind_speed - 2.0, 0)` で算出

**`is_extreme_weather`（悪天候フラグ）**
- 大雨・大雪・強風を個別に扱うより複合フラグの方が需要抑制を端的に表現できると判断

**`days_since_last_operation`（前回運行からの経過日数）**
- 連休明けなど需要が蓄積されるパターンを捉えるため追加

---

## 需要生成モデル（base_lambda）の構造

```
λ = 時間帯基礎値
  × 月別係数（実データ較正）
  × カレンダー補正（週末・祝日・学期・農繁期・月初月末・連休）
  × 気象補正（体感温度・降水量・積雪・強風）
```

最終的に `demand_count = Poisson(λ)` からサンプリング。λ=0の場合は0を返す。

---

## 改良効果（AutoGluon / extremeプリセット）

| バージョン                             | RMSE       |
| -------------------------------------- | ---------- |
| 旧ダミーデータ                         | 0.8097     |
| **改良版ダミーデータ（本スクリプト）** | **0.5688** |

実データのパターンを反映することで約**30%の精度改善**を達成。

---

## 今後の改善余地

- **診療所の診察日フラグ**：過疎地では週数回しか開院しない診療所があり、通院需要への影響が大きい
- **地域イベント・行事フラグ**：祭り・選挙日・地域の集まり等
- **実データとの係数の継続的な較正**：年度が進むにつれて需要パターンが変化する可能性がある