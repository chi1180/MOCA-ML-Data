# Demand Generator for On-Demand Bus Simulation

`expanded_points.csv` に定義された停留所スコアを物理的な重み（Weight）として扱い、**需要数予測モデルの学習に適した時系列データセット**を生成するシミュレーションエンジンです。

---

## 1. 概要

本スクリプトは、東広島市福富町周辺の停留所データを基に、3年分（2022/04/01 〜 2025/03/31）の架空の運行需要レコードを生成します。

出力は「1件の予約レコード」ではなく、**「1日 × 1時間帯」を1行とした集計形式**です。目的変数 `demand_count`（その時間帯の予約件数）を予測する機械学習モデルの学習データとして設計されています。

各時間帯の需要数は、以下の要素を組み合わせたポアソン過程によって生成されます。

- 時間帯（morning / daytime / evening）の基礎需要
- カレンダー情報（曜日・祝日・学期・農繁期・月初月末）
- 気象情報（気温・降水量・積雪・風速）
- ラグ特徴量（前日・1週前・直近平均需要数）

また、予約ゼロの時間帯も意図的に生成することで、モデルが「需要なし」も学習できる現実的な疎なデータセットとなっています。

---

## 2. 数学的ロジック

### A. 時間帯需要数の決定（ポアソン分布）

各時間帯の予約件数 $N$ は、以下のポアソン分布に従って決定されます。

$$N \sim \text{Poisson}(\lambda)$$

$\lambda$（プログラム中の `base_lambda()`）は**時間帯の基礎需要に各種補正係数を乗算**して算出されます。

$$\lambda = \lambda_{\text{base}} \times C_{\text{calendar}} \times C_{\text{weather}}$$

| 補正係数              | 内容                                          | 補正値の例                                     |
| --------------------- | --------------------------------------------- | ---------------------------------------------- |
| $C_{\text{calendar}}$ | 学期中の朝は需要増、長期休暇中は抑制          | 学期中朝: ×1.50 / 休暇中朝: ×0.40              |
| $C_{\text{calendar}}$ | 週末・祝日は全体需要が減少                    | ×0.55（ただし昼の観光需要は ×1.30 で部分回復） |
| $C_{\text{calendar}}$ | 農繁期（5・6・9・10月）の朝夕は農家移動で増加 | ×1.20                                          |
| $C_{\text{calendar}}$ | 月初・月末の昼は通院需要が集中                | ×1.35                                          |
| $C_{\text{weather}}$  | 快適な気温（15〜25℃）は外出を促進             | ×1.10                                          |
| $C_{\text{weather}}$  | 大雨（20mm以上）は外出を大幅抑制              | ×0.40                                          |
| $C_{\text{weather}}$  | 大雪（10cm以上）はほぼ外出不可                | ×0.20                                          |

### B. 気象データのシミュレーション

天候は東広島市の実測値を参考にした月別パラメータから生成されます。

- **気温**: 月別平均・標準偏差を持つ正規分布でサンプリング
- **降水量**: 月別降水確率で降雨の有無を決定し、発生時は指数分布（平均 8mm）で雨量を算出
- **積雪**: 1〜2月かつ気温 0℃以下かつ降水がある場合のみ、指数分布（平均 3cm）で算出
- **風速**: 指数分布（平均 2.5m/s）でサンプリング

### C. ラグ特徴量の付与

時系列モデルに不可欠なラグ特徴量を、時間帯ごとに独立して計算します。これにより「1週間前の同じ時間帯に需要が多かった → 今日も多い可能性が高い」という周期パターンをモデルが学習できます。

$$\text{lag\_7\_demand}_t = \text{demand\_count}_{t-7}$$

---

## 3. データ構造（dummy.csv）

1行 = 1日 × 1時間帯の集計レコードです。

### 識別子

| カラム名    | 説明                                      | 型                  |
| ----------- | ----------------------------------------- | ------------------- |
| `date`      | 日付                                      | String (YYYY-MM-DD) |
| `time_slot` | 時間帯区分（morning / daytime / evening） | String              |

### 目的変数

| カラム名       | 説明                                | 型  |
| -------------- | ----------------------------------- | --- |
| `demand_count` | その日・時間帯の予約件数（0を含む） | Int |

### カレンダー特徴量

| カラム名            | 説明                                           | 型        |
| ------------------- | ---------------------------------------------- | --------- |
| `day_of_week`       | 曜日（0=月曜 〜 6=日曜）                       | Int       |
| `month`             | 月                                             | Int       |
| `is_weekend`        | 週末フラグ                                     | Int (0/1) |
| `is_holiday`        | 祝日フラグ（2022〜2025年の日本の祝日に対応）   | Int (0/1) |
| `is_school_term`    | 学期中フラグ（広島県の学校カレンダーに準拠）   | Int (0/1) |
| `is_farming_season` | 農繁期フラグ（田植え: 5〜6月 / 収穫: 9〜10月） | Int (0/1) |
| `is_month_boundary` | 月初（1〜5日）・月末（25日〜）フラグ           | Int (0/1) |
| `season`            | 季節（spring / summer / autumn / winter）      | String    |

### 気象特徴量

| カラム名           | 説明                                         | 型     |
| ------------------ | -------------------------------------------- | ------ |
| `temperature`      | 気温（℃）                                    | Float  |
| `precipitation_mm` | 降水量（mm）                                 | Float  |
| `snowfall_cm`      | 積雪量（cm）。非降雪時は 0.0                 | Float  |
| `wind_speed`       | 風速（m/s）                                  | Float  |
| `weather_label`    | 天候ラベル（sunny / cloudy / rainy / snowy） | String |

### ラグ特徴量

| カラム名            | 説明                                 | 型    |
| ------------------- | ------------------------------------ | ----- |
| `lag_1_demand`      | 前日の同時間帯の需要数               | Float |
| `lag_7_demand`      | 1週前の同時間帯の需要数              | Float |
| `lag_14_demand`     | 2週前の同時間帯の需要数              | Float |
| `rolling_7day_avg`  | 直近7日の同時間帯の需要数の移動平均  | Float |
| `rolling_14day_avg` | 直近14日の同時間帯の需要数の移動平均 | Float |

> **Note:** ラグ特徴量が計算できない生成開始直後の行（約2週間分）はデータセットから除去されます。

---

## 4. ディレクトリ構成

本スクリプトは以下の構成を前提としています。

```
project/
├── data/
│   ├── expanded_points.csv   # 入力: 停留所スコアデータ
│   └── dummy.csv             # 出力: 生成されたダミーデータ
└── scripts/
    └── generate_demand_data.py
```

---

## 5. 実行環境とセットアップ

### Prerequisites

- Python 3.10+
- `pandas`, `numpy`
- `data/expanded_points.csv`（入力データ）

### Usage

```bash
cd scripts
python generate_demand_data.py
```

実行が完了すると、`data/dummy.csv` に生成結果が保存されます。コンソールには以下のサマリーが出力されます。

```
✅ 生成完了: 3267 レコード（ゼロ需要含む）
   期間: 2022-04-08 〜 2025-03-31
   保存先: ../data/dummy.csv

── 需要数の分布 ──
── 時間帯別 平均需要数 ──
── 曜日別 平均需要数 ──
── 天候ラベル別 平均需要数 ──
── 学期中 vs 休暇中（morning）──
── ゼロ需要の割合 ──
```

---

## 6. 生成データの統計的特性

生成データは以下の特性を持つことが期待されます。実際の出力と大きく乖離している場合は `SEED` 値や `base_lambda()` 内の補正係数を見直してください。

| 指標                  | 期待値の目安                               |
| --------------------- | ------------------------------------------ |
| 総レコード数          | 約 3,270件（3年分 × 3時間帯 − ラグ除去分） |
| 平均需要数 / 時間帯   | 0.6 〜 0.9件                               |
| ゼロ需要の割合        | 50〜60%                                    |
| 学期中 morning の需要 | 休暇中の約3倍                              |
| 雪天時の需要          | 晴天時の約20%                              |

---

## 7. カスタマイズ

生成データのパラメータはスクリプト冒頭・`base_lambda()` 内で調整可能です。

```python
# 期間の変更
START_DATE = date(2022, 4, 1)
END_DATE   = date(2025, 3, 31)

# 基礎需要の調整（実データと乖離する場合はここを変更）
slot_base = {"morning": 0.90, "daytime": 0.75, "evening": 0.45}
```

実際の運行実績データが入手できた場合は、`slot_base` の値を実測の平均需要数に合わせてキャリブレーションすることを推奨します。